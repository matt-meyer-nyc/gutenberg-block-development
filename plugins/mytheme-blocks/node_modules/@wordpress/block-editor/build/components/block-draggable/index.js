"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _element = require("@wordpress/element");

var _lodash = require("lodash");

var _components = require("@wordpress/components");

var _data = require("@wordpress/data");

/**
 * External dependencies
 */

/**
 * WordPress dependencies
 */
var BlockDraggable = function BlockDraggable(_ref) {
  var children = _ref.children,
      clientIds = _ref.clientIds;

  var _useSelect = (0, _data.useSelect)(function (select) {
    var _select = select('core/block-editor'),
        getBlockIndex = _select.getBlockIndex,
        getBlockRootClientId = _select.getBlockRootClientId,
        getTemplateLock = _select.getTemplateLock;

    var normalizedClientIds = (0, _lodash.castArray)(clientIds);
    var rootClientId = normalizedClientIds.length === 1 ? getBlockRootClientId(normalizedClientIds[0]) : null;
    var templateLock = rootClientId ? getTemplateLock(rootClientId) : null;
    return {
      index: getBlockIndex(normalizedClientIds[0], rootClientId),
      srcRootClientId: rootClientId,
      isDraggable: normalizedClientIds.length === 1 && 'all' !== templateLock
    };
  }, [clientIds]),
      srcRootClientId = _useSelect.srcRootClientId,
      index = _useSelect.index,
      isDraggable = _useSelect.isDraggable;

  var isDragging = (0, _element.useRef)(false);

  var _useDispatch = (0, _data.useDispatch)('core/block-editor'),
      startDraggingBlocks = _useDispatch.startDraggingBlocks,
      stopDraggingBlocks = _useDispatch.stopDraggingBlocks; // Stop dragging blocks if the block draggable is unmounted


  (0, _element.useEffect)(function () {
    return function () {
      if (isDragging.current) {
        stopDraggingBlocks();
      }
    };
  }, []);

  if (!isDraggable) {
    return null;
  }

  var normalizedClientIds = (0, _lodash.castArray)(clientIds);
  var blockElementId = "block-".concat(normalizedClientIds[0]);
  var transferData = {
    type: 'block',
    srcIndex: index,
    srcClientId: normalizedClientIds[0],
    srcRootClientId: srcRootClientId
  };
  return (0, _element.createElement)(_components.Draggable, {
    elementId: blockElementId,
    transferData: transferData,
    onDragStart: function onDragStart() {
      startDraggingBlocks();
      isDragging.current = true;
    },
    onDragEnd: function onDragEnd() {
      stopDraggingBlocks();
      isDragging.current = false;
    }
  }, function (_ref2) {
    var onDraggableStart = _ref2.onDraggableStart,
        onDraggableEnd = _ref2.onDraggableEnd;
    return children({
      onDraggableStart: onDraggableStart,
      onDraggableEnd: onDraggableEnd
    });
  });
};

var _default = BlockDraggable;
exports.default = _default;
//# sourceMappingURL=index.js.map