{"version":3,"sources":["@wordpress/block-editor/src/components/observe-typing/index.js"],"names":["KEY_DOWN_ELIGIBLE_KEY_CODES","UP","RIGHT","DOWN","LEFT","ENTER","BACKSPACE","isKeyDownEligibleForStartTyping","event","keyCode","shiftKey","ObserveTyping","children","setSafeTimeout","setTimeout","lastMouseMove","isTyping","select","startTyping","stopTyping","toggleEventBindings","isBound","bindFn","document","stopTypingOnSelectionUncollapse","stopTypingOnMouseMove","clientX","clientY","current","lastClientX","lastClientY","selection","window","getSelection","isCollapsed","rangeCount","getRangeAt","collapsed","stopTypingOnEscapeKey","ESCAPE","startTypingInTextField","type","target","closest","stopTypingOnNonTextField"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { over, includes } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { useRef, useEffect } from '@wordpress/element';\nimport { useSelect, useDispatch } from '@wordpress/data';\nimport { isTextField } from '@wordpress/dom';\nimport {\n\tUP,\n\tRIGHT,\n\tDOWN,\n\tLEFT,\n\tENTER,\n\tBACKSPACE,\n\tESCAPE,\n} from '@wordpress/keycodes';\nimport { withSafeTimeout } from '@wordpress/compose';\n\n/**\n * Set of key codes upon which typing is to be initiated on a keydown event.\n *\n * @type {number[]}\n */\nconst KEY_DOWN_ELIGIBLE_KEY_CODES = [ UP, RIGHT, DOWN, LEFT, ENTER, BACKSPACE ];\n\n/**\n * Returns true if a given keydown event can be inferred as intent to start\n * typing, or false otherwise. A keydown is considered eligible if it is a\n * text navigation without shift active.\n *\n * @param {KeyboardEvent} event Keydown event to test.\n *\n * @return {boolean} Whether event is eligible to start typing.\n */\nfunction isKeyDownEligibleForStartTyping( event ) {\n\tconst { keyCode, shiftKey } = event;\n\treturn ! shiftKey && includes( KEY_DOWN_ELIGIBLE_KEY_CODES, keyCode );\n}\n\nfunction ObserveTyping( { children, setTimeout: setSafeTimeout } ) {\n\tconst lastMouseMove = useRef();\n\tconst isTyping = useSelect( ( select ) =>\n\t\tselect( 'core/block-editor' ).isTyping()\n\t);\n\tconst { startTyping, stopTyping } = useDispatch( 'core/block-editor' );\n\tuseEffect( () => {\n\t\ttoggleEventBindings( isTyping );\n\t\treturn () => toggleEventBindings( false );\n\t}, [ isTyping ] );\n\n\t/**\n\t * Bind or unbind events to the document when typing has started or stopped\n\t * respectively, or when component has become unmounted.\n\t *\n\t * @param {boolean} isBound Whether event bindings should be applied.\n\t */\n\tfunction toggleEventBindings( isBound ) {\n\t\tconst bindFn = isBound ? 'addEventListener' : 'removeEventListener';\n\t\tdocument[ bindFn ](\n\t\t\t'selectionchange',\n\t\t\tstopTypingOnSelectionUncollapse\n\t\t);\n\t\tdocument[ bindFn ]( 'mousemove', stopTypingOnMouseMove );\n\t}\n\n\t/**\n\t * On mouse move, unset typing flag if user has moved cursor.\n\t *\n\t * @param {MouseEvent} event Mousemove event.\n\t */\n\tfunction stopTypingOnMouseMove( event ) {\n\t\tconst { clientX, clientY } = event;\n\n\t\t// We need to check that the mouse really moved because Safari triggers\n\t\t// mousemove events when shift or ctrl are pressed.\n\t\tif ( lastMouseMove.current ) {\n\t\t\tconst {\n\t\t\t\tclientX: lastClientX,\n\t\t\t\tclientY: lastClientY,\n\t\t\t} = lastMouseMove.current;\n\n\t\t\tif ( lastClientX !== clientX || lastClientY !== clientY ) {\n\t\t\t\tstopTyping();\n\t\t\t}\n\t\t}\n\n\t\tlastMouseMove.current = { clientX, clientY };\n\t}\n\n\t/**\n\t * On selection change, unset typing flag if user has made an uncollapsed\n\t * (shift) selection.\n\t */\n\tfunction stopTypingOnSelectionUncollapse() {\n\t\tconst selection = window.getSelection();\n\t\tconst isCollapsed =\n\t\t\tselection.rangeCount > 0 && selection.getRangeAt( 0 ).collapsed;\n\n\t\tif ( ! isCollapsed ) {\n\t\t\tstopTyping();\n\t\t}\n\t}\n\n\t/**\n\t * Unsets typing flag if user presses Escape while typing flag is active.\n\t *\n\t * @param {KeyboardEvent} event Keypress or keydown event to interpret.\n\t */\n\tfunction stopTypingOnEscapeKey( event ) {\n\t\tif ( isTyping && event.keyCode === ESCAPE ) {\n\t\t\tstopTyping();\n\t\t}\n\t}\n\n\t/**\n\t * Handles a keypress or keydown event to infer intention to start typing.\n\t *\n\t * @param {KeyboardEvent} event Keypress or keydown event to interpret.\n\t */\n\tfunction startTypingInTextField( event ) {\n\t\tconst { type, target } = event;\n\n\t\t// Abort early if already typing, or key press is incurred outside a\n\t\t// text field (e.g. arrow-ing through toolbar buttons).\n\t\t// Ignore typing in a block toolbar\n\t\tif (\n\t\t\tisTyping ||\n\t\t\t! isTextField( target ) ||\n\t\t\ttarget.closest( '.block-editor-block-toolbar' )\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Special-case keydown because certain keys do not emit a keypress\n\t\t// event. Conversely avoid keydown as the canonical event since there\n\t\t// are many keydown which are explicitly not targeted for typing.\n\t\tif (\n\t\t\ttype === 'keydown' &&\n\t\t\t! isKeyDownEligibleForStartTyping( event )\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tstartTyping();\n\t}\n\n\t/**\n\t * Stops typing when focus transitions to a non-text field element.\n\t *\n\t * @param {FocusEvent} event Focus event.\n\t */\n\tfunction stopTypingOnNonTextField( event ) {\n\t\tconst { target } = event;\n\n\t\t// Since focus to a non-text field via arrow key will trigger before\n\t\t// the keydown event, wait until after current stack before evaluating\n\t\t// whether typing is to be stopped. Otherwise, typing will re-start.\n\t\tsetSafeTimeout( () => {\n\t\t\tif ( isTyping && ! isTextField( target ) ) {\n\t\t\t\tstopTyping();\n\t\t\t}\n\t\t} );\n\t}\n\n\t// Disable reason: This component is responsible for capturing bubbled\n\t// keyboard events which are interpreted as typing intent.\n\n\t/* eslint-disable jsx-a11y/no-static-element-interactions */\n\treturn (\n\t\t<div\n\t\t\tonFocus={ stopTypingOnNonTextField }\n\t\t\tonKeyPress={ startTypingInTextField }\n\t\t\tonKeyDown={ over( [\n\t\t\t\tstartTypingInTextField,\n\t\t\t\tstopTypingOnEscapeKey,\n\t\t\t] ) }\n\t\t>\n\t\t\t{ children }\n\t\t</div>\n\t);\n\t/* eslint-enable jsx-a11y/no-static-element-interactions */\n}\n\n/**\n * @see https://github.com/WordPress/gutenberg/blob/master/packages/block-editor/src/components/observe-typing/README.md\n */\nexport default withSafeTimeout( ObserveTyping );\n"]}